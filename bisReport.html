<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sorontil - Reports</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.2/css/bulma.min.css">
  <script async>

    //#region filtering
    let currentFilterById;

    function toggleFilter() {
      // TODO: close sort dropdown when clicking elsewhere in the page
      const filterButton = document.getElementById('filter-button');
      if (filterButton.classList.contains('is-active')) {
        filterButton.classList.remove('is-active');
      } else {
        filterButton.classList.add('is-active');
      }
    }
    //#endregion

    //#region sorting
    let currentSortById = 'sort-by-time';

    function toggleSort() {
      // TODO: close sort dropdown when clicking elsewhere in the page
      const sortButton = document.getElementById('sort-button');
      if (sortButton.classList.contains('is-active')) {
        sortButton.classList.remove('is-active');
      } else {
        sortButton.classList.add('is-active');
      }
    }

    function sortBy(id) {
      if (id !== currentSortById) {
        const selectedElement = document.getElementById(id);
        selectedElement.classList.add('is-active');
        document.getElementById(currentSortById).classList.remove('is-active');
        document.getElementById('current-sort-by').innerText = selectedElement.innerText;
        toggleSort();
        currentSortById = id;
      }
      sortTable(id);
    }

    function sortTable(id) {
      let table, rows, switching, i, x, y, shouldSwitch, columnIndex;
      const columnToIndexMap = {
        'sort-by-time': 0,
        'sort-by-users': 1,
        'sort-by-status': 4
      };
      table = document.getElementById('table-body');
      columnIndex = columnToIndexMap[id];
      switching = true;
      // Make a loop that will continue until no switching has been done
      while (switching) {
        switching = false;
        rows = table.rows;
        // Loop through all table rows
        for (i = 0; i < (rows.length - 1); i++) {
          shouldSwitch = false;
          // Get the two elements you want to compare, one from current row and one from the next
          x = rows[i].getElementsByTagName("TD")[columnIndex];
          y = rows[i + 1].getElementsByTagName("TD")[columnIndex];
          // Check if the two rows should switch place:
          if (shouldSwitchRows(id, x, y)) {
            shouldSwitch = true;
            break;
          }
        }
        if (shouldSwitch) {
          // If a switch has been marked, make the switch and mark that a switch has been done
          rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
          switching = true;
        }
      }
    }

    function shouldSwitchRows(id, x, y) {
      if (id === 'sort-by-users' || id === 'sort-by-status') {
        if (x.innerHTML.toLowerCase() > y.innerHTML.toLowerCase()) {
          return true;
        }
      }
      if (id === 'sort-by-time') {
        // format from server is 2021-05-31 12:45:58.929, timezone unknown
        // TODO: display in format Fri, 16 May 2015 05:40:02 GMT
        let regex = /(\d{4})-(\d{2})-(\d{2})\s(\d{2}):(\d{2}):(\d{2})\.(\d{3})/;
        let xMatch = regex.exec(x.innerHTML);
        let yMatch = regex.exec(y.innerHTML);
        let xDate = new Date(xMatch[1], xMatch[2] - 1, xMatch[3], xMatch[4], xMatch[5], xMatch[6], xMatch[7]);
        let yDate = new Date(yMatch[1], yMatch[2] - 1, yMatch[3], yMatch[4], yMatch[5], yMatch[6], yMatch[7]);

        if (xDate > yDate) {
          return true;
        }
      }
      return false;
    }
    //#endregion

    //#region initialization
    function populateTable() {
      // TODO: Get this data from the server and convert into a user-friendly format
      data = [
        ["2021-05-31 12:45:58.929", "jason@lfd", "+14031234567", "SMS1", "Succeeded"],
        ["2021-05-31 01:45:58.929", "katherine@lfd", "+14031234567", "SMS2", "Succeeded"],
        ["2021-05-31 11:45:58.929", "Candace@lfd", "+14031234567", "SMS3", "Succeeded"],
        ["2021-05-31 03:45:58.929", "John@lfd", "+14031234567", "SMS4", "Succeeded"],
        ["2021-05-31 24:45:58.929", "Jane@lfd", "+14031234567", "SMS5", "Succeeded"],
        ["2021-05-31 15:45:58.929", "Michael@lfd", "+14031234567", "SMS6", "Succeeded"],
        ["2021-05-31 16:45:58.929", "Jim@lfd", "+14031234567", "SMS7", "Succeeded"],
        ["2021-05-31 12:35:58.929", "Joe@lfd", "+14031234567", "SMS8", "Succeeded"],
        ["2021-05-31 12:25:58.929", "Paul@lfd", "+14031234567", "SMS9", "Succeeded"],
        ["2021-05-31 12:46:58.929", "Bob@lfd", "+14031234567", "SMS10", "Succeeded"],
        ["2021-05-31 12:21:58.929", "Alice@lfd", "+14031234567", "SMS11", "Failed"],
        ["2021-05-31 12:45:04.929", "Lisa@lfd", "+14031234567", "SMS12", "Succeeded"],
        ["2021-05-31 12:45:12.929", "james@lfd", "+14031234567", "SMS13", "Succeeded"],
        ["2021-09-31 12:45:58.929", "tim@lfd", "+14031234567", "SMS14", "Succeeded"],
        ["2021-07-31 12:45:58.929", "alexander@lfd", "+14031234567", "SMS15", "Succeeded"]
      ];

      const tableBody = document.getElementById('table-body');
      let rowNum = 0;
      data.forEach(x => {
        let row = tableBody.insertRow(rowNum);
        let cellNum = 0;
        x.forEach(y => {
          let cell = row.insertCell(cellNum);
          cell.innerHTML = y;
          if (y === 'Succeeded') {
            cell.style.color = 'green';
          }
          if (y === 'Failed') {
            cell.style.color = 'red';
          }
          cellNum++;
        });
        rowNum++;
      });

      sortTable('sort-by-time');
    }

    document.addEventListener('DOMContentLoaded', () => {
      // Get all "navbar-burger" elements
      const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);

      // Check if there are any navbar burgers
      if ($navbarBurgers.length > 0) {

        // Add a click event on each of them
        $navbarBurgers.forEach(el => {
          el.addEventListener('click', () => {

            // Get the target from the "data-target" attribute
            const target = el.dataset.target;
            const $target = document.getElementById(target);

            // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
            el.classList.toggle('is-active');
            $target.classList.toggle('is-active');
          });
        });
      }

      populateTable();
    });
    //#endregion
  </script>
</head>

<body>
  <nav class="navbar is-info" role="navigation" aria-label="main navigation">
    <div class="navbar-brand">
      <a class="navbar-item">
        <span style="font-size: 1.5em">
          <strong>Sorontil</strong>
        </span>
      </a>

      <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navigation-bar">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>

    <div id="navigation-bar" class="navbar-menu">
      <div class="navbar-start">
        <a class="navbar-item">
          Home
        </a>

        <a class="navbar-item is-active">
          Reports
        </a>
      </div>

      <div class="navbar-end">
        <div class="navbar-item">
          <a class="button" style="color: red">
            Log out
          </a>
        </div>
      </div>
    </div>
  </nav>

  <section class="section">
    <div class="columns">
      <div class="column">
        <div id="sort-button" class="dropdown">
          <div class="dropdown-trigger">
            <button class="button" aria-haspopup="true" aria-controls="dropdown-menu" onclick="toggleSort()">
              Sort by: &nbsp<strong><span id="current-sort-by">Time</span></strong>
            </button>
          </div>
          <div class="dropdown-menu" id="dropdown-menu" role="menu">
            <div class="dropdown-content">
              <a id="sort-by-time" class="dropdown-item is-active" onclick="sortBy(this.id)">
                Time
              </a>
              <a id="sort-by-users" class="dropdown-item" onclick="sortBy(this.id)">
                User Id
              </a>
              <a id="sort-by-status" class="dropdown-item" onclick="sortBy(this.id)">
                Status
              </a>
            </div>
          </div>
        </div>
        <div id="filter-button" class="dropdown">
          <div class="dropdown-trigger">
            <button class="button" aria-haspopup="true" aria-controls="dropdown-menu" onclick="toggleFilter()">
              View last: &nbsp<strong><span id="current-sort-by">1 hour</span></strong>
            </button>
          </div>
          <div class="dropdown-menu" id="dropdown-menu" role="menu">
            <div class="dropdown-content">
              <a id="filter-1-hour" class="dropdown-item is-active" onclick="filterBy(this.id)">
                Last 1 hour
              </a>
              <a id="filter-24-hour" class="dropdown-item" onclick="filterBy(this.id)">
                Last 24 hours
              </a>
              <a id="filter-48-hour" class="dropdown-item" onclick="filterBy(this.id)">
                Last 48 hours
              </a>
              <a id="filter-7-days" class="dropdown-item" onclick="filterBy(this.id)">
                Last 7 days
              </a>
              <a id="filter-30-days" class="dropdown-item" onclick="filterBy(this.id)">
                Last 30 days
              </a>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div class="table-container">
      <table class="table is-striped">
        <thead>
          <tr>
            <th>Time</th>
            <th>User Id</th>
            <th>Phone Number</th>
            <th>Id</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="table-body">
        </tbody>
      </table>
    </div>
  </section>
</body>

</html>