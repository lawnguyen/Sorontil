<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sorontil - Client Services</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.2/css/bulma.min.css">
  <script async>

    //#region send sms
    let phoneNumbers = [];
    function sendSMS() {
      // TODO: send sms function here
    }
    //#endregion

    //#region character counter
    function setCharacterCounter(currentLength, maxLength) {
      const charCounter = document.getElementById('character-counter');
      if (currentLength == maxLength) {
        charCounter.style.color = 'red';
        charCounter.innerHTML = `Maximum reached! ${currentLength}/${maxLength}`;
      } else {
        charCounter.style.color = 'green';
        charCounter.innerHTML = `${currentLength}/${maxLength}`;
      }
    }
    //#endregion

    //#region phone number validation
    function processPhoneNumbers(target) {
      let unformattedToOriginalNumberMap = {};
      let numbers = target.value.split(/[ ,]+/);  // split by whitespace or comma

      const numbersUnformatted = numbers.map(num => {
        const unformatted = num.replace(/\D/g, "");
        unformattedToOriginalNumberMap[unformatted] = num;
        return unformatted;
      });

      numbersUnformatted.forEach(numberUnformatted => {
        const number = unformattedToOriginalNumberMap[numberUnformatted];

        if ((numberUnformatted.length === 11 && numberUnformatted[0] === '1') ||
          (numberUnformatted.length === 10 && numberUnformatted[0] !== '1')) {
          phoneNumbers.push(numberUnformatted);

          const numberTag = createNumberTagElement(number.trim().replace(',', ''));
          numberTag.addEventListener(getTransitionEndEventName(), (e) => {
            e.target.parentElement.parentElement.remove();
          })
          numberTag.firstChild.childNodes[1].addEventListener('click', (e) => {
            const xButtonElement = e.target;
            const tagElement = xButtonElement.previousSibling;
            xButtonElement.style.transition = "all 0.5s ease-out";
            xButtonElement.style.fontSize = 0;
            tagElement.style.transition = "all 0.5s ease-out";
            tagElement.style.fontSize = 0;
          });
          document.getElementById('phone-numbers-list').appendChild(numberTag);

          // Clear the input field
          document.getElementById('phone-numbers').value = '';
          return;
        }
        console.log('invalid');
        return;
      });
    }

    function createNumberTagElement(number) {
      const div = document.createElement('div');
      div.innerHTML =
        "<div class='control number-tag'>" +
        "<div class='tags has-addons'>" +
        "<span class='tag'>" + number + "</span>" +
        "<span class='tag is-delete is-danger is-light'></span>" +
        "</div></div>"
      return div.firstChild;
    }

    // Get Transition end event name based on browser
    function getTransitionEndEventName() {
      var transitions = {
        "transition": "transitionend",
        "OTransition": "oTransitionEnd",
        "MozTransition": "transitionend",
        "WebkitTransition": "webkitTransitionEnd"
      }
      let bodyStyle = document.body.style;
      for (let transition in transitions) {
        if (bodyStyle[transition] != undefined) {
          return transitions[transition];
        }
      }
    }
    //#endregion

    //#region initialization
    document.addEventListener('DOMContentLoaded', () => {
      // Get all "navbar-burger" elements
      const $navbarBurgers = Array.prototype.slice.call(document.querySelectorAll('.navbar-burger'), 0);

      // Check if there are any navbar burgers
      if ($navbarBurgers.length > 0) {

        // Add a click event on each of them
        $navbarBurgers.forEach(el => {
          el.addEventListener('click', () => {

            // Get the target from the "data-target" attribute
            const target = el.dataset.target;
            const $target = document.getElementById(target);

            // Toggle the "is-active" class on both the "navbar-burger" and the "navbar-menu"
            el.classList.toggle('is-active');
            $target.classList.toggle('is-active');
          });
        });
      }

      // TODO: Get company name from server and set as header

      // Character counter event listener
      const messageBody = document.getElementById('message-body');
      const messageMaxLength = messageBody.getAttribute('maxlength');
      messageBody.addEventListener('input', (e) => {
        const target = e.target;

        // Count the current number of characters
        const currentLength = target.value.length;
        setCharacterCounter(currentLength, messageMaxLength);
      });

      setCharacterCounter(0, messageMaxLength);

      // Phone numbers event listener
      const phoneNumbers = document.getElementById('phone-numbers');
      phoneNumbers.addEventListener('input', (e) => {
        processPhoneNumbers(e.target);
      });
    });
    //#endregion
  </script>
</head>

<body>
  <nav class="navbar is-info" role="navigation" aria-label="main navigation">
    <div class="navbar-brand">
      <a class="navbar-item">
        <span style="font-size: 1.5em">
          <strong>Sorontil</strong>
        </span>
      </a>

      <a role="button" class="navbar-burger" aria-label="menu" aria-expanded="false" data-target="navigation-bar">
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
        <span aria-hidden="true"></span>
      </a>
    </div>

    <div id="navigation-bar" class="navbar-menu">
      <div class="navbar-start">
        <a class="navbar-item is-active">
          Home
        </a>

        <a class="navbar-item">
          Reports
        </a>
      </div>

      <div class="navbar-end">
        <div class="navbar-item">
          <a class="button" style="color: red">
            <span>Log out &nbsp</span>
            <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="red">
              <path d="M0 0h24v24H0z" fill="none" />
              <path
                d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z" />
            </svg>
          </a>
        </div>
      </div>
    </div>
  </nav>
  <section class="section">
    <div class="columns is-mobile">
      <div class="column is-three-fifths-desktop is-offset-one-fifth-desktop">
        <h1 class="title is-1">
          <strong>LE FAMILY DENTAL</strong>
        </h1>
        <div class="field">
          <label class="label">Message body [80 x 4] (max. 160 characters):</label>
          <div class="control">
            <textarea id="message-body" class="textarea is-info" maxlength="160"></textarea>
            <div style="display: flex; justify-content: flex-end" id="character-counter"></div>
          </div>
        </div>

        <div class="field">
          <label class="label">Client mobile phone numbers:</label>
          <div class="control">
            <textarea id="phone-numbers" class="input is-info" type="textarea"
              placeholder="Enter numbers separated by space, comma, or new-line"></textarea>
          </div>
        </div>

        <div id="phone-numbers-list" class="field is-grouped is-grouped-multiline">
        </div>

        <div class="field is-grouped" style="display: flex; justify-content: space-between; margin-top: 50px;">
          <div class="control">
            <button class="button is-info" onclick="sendSMS()">
              <span>Send &nbsp</span>
              <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 0 24 24" width="24px" fill="#ffffff">
                <path d="M0 0h24v24H0z" fill="none" />
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z" />
              </svg>
            </button>
          </div>
          <div class="control" style="display: flex; justify-content: flex-end">
            <button class="button is-info is-light">
              <span>Clear all</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </section>
</body>

</html>